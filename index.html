<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Test - GyorsGépelés</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            margin: 0;
            background: #0f172a;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app {
            width: 800px;
            max-width: 95%;
            background: #020617;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,.5);
        }

        h1 {
            text-align: center;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .words {
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 12px;
            padding: 16px;
            min-height: 120px;
            line-height: 2.2;
            font-size: 20px;
            margin-bottom: 16px;
            user-select: none;
        }

        .word {
            margin-right: 6px;
        }

        .correct {
            color: #22c55e;
        }

        .wrong {
            color: #ef4444;
            text-decoration: underline;
        }

        .active {
            background: #1e293b;
            padding: 2px 4px;
            border-radius: 4px;
        }

        input {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            border-radius: 10px;
            border: none;
            outline: none;
            background: #020617;
            color: #e5e7eb;
            border: 1px solid #1e293b;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            font-size: 14px;
            color: #94a3b8;
        }

        .stats strong {
            color: #e5e7eb;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: #2563eb;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .select {
            width: 6rem;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: #2563eb;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .select:hover {
            background: #1d4ed8;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.7);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #020617;
            padding: 24px;
            border-radius: 16px;
            width: 320px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,.6);
        }

        .hidden {
            display: none;
        }
        .leaderboard{
            margin-top: 2rem;
            background: #0f172a;
            border: 1px solid #1d4ed8;
            border-radius: 1rem;
            padding: 1rem;
        }
        .leaderboard h2{
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: 1rem;
        }
        .lb-item{
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #1e293b;
            transition: 0.2s;
        }
        .lb-item:hover{
            background: #1e293b;
        }
        .lb-rank{
            font-weight: bold;
            width: 2rem;
        }

        .lb-name{
            flex: 1;
        }
        .lb-wpm{
            font-weight: bold;
            color: #e5e7eb;
        }
        .gold{
            color: gold;
        }
        .silver{
            color: silver;
        }
        .bronze{
            color: burlywood;
        }
    </style>
</head>
<body>
    <div class="app">
        <h1>Gépelési Teszt</h1>
        <button id="startBtn" class="btn">Indítás</button>
        <div style="display: flex; gap: 10px; margin-bottom: 1rem;">

            <select name="duration" id="duration" class="select">
                <option value="15">15 mp</option>
                <option value="30">30 mp</option>
                <option value="60">60 mp</option>
                <option value="120">120 mp</option>

            </select>
        </div>

        <div id="words" class="words hidden"></div>
        
        <input type="text" id="input" placeholder="Kezdj el gépelni..." autocomplete="off" disabled>

        <div class="stats">
            <div>Idő: <strong><span id="time">60</span>s</strong></div>
            <div>Helyes: <strong><span id="correct">0</span></strong></div>
            <div>Hibás: <strong><span id="wrong">0</span></strong></div>
            <div>WPM: <strong><span id="wpm">0</span></strong></div>
            <div>CPM: <strong><span id="cpm">0</span></strong></div>
            <div>Accuracy: <strong><span id="accuracy">0</span></strong></div>

        </div>
        <button id="restart" class="btn" onclick="restart()" >Újraindítás</button>

        <div class="leaderboard">
        <h2>Ranglista</h2>
        <div id="leaderboardList"></div>
    </div>
    </div>

    <div id="resultModal" class="modal hidden" onclick="hideModal()">
        <div class="modal-content">
            <h2>Eredmények</h2>
            <p>Helyes: <strong id="mCorrect"></strong></p>
            <p>Hibás: <strong id="mWrong"></strong></p>
            <p>WPM: <strong id="mWpm"></strong></p>
            <button class="btn" onclick="restart()">Újraindítás</button>
        </div>
    </div>

    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { addDoc, 
        getFirestore, 
        collection, 
        serverTimestamp, 
        query, 
        orderBy, 
        limit, 
        getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD1CUcSascBEeFqExnmWPqwmZ6ASS1-LUo",
        authDomain: "typingtest-12526.firebaseapp.com",
        projectId: "typingtest-12526",
        storageBucket: "typingtest-12526.firebasestorage.app",
        messagingSenderId: "600618857718",
        appId: "1:600618857718:web:1cd2a874f2abc7fb0828d7",
        measurementId: "G-6H2XSFBFF5"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app)

    window.db = db
    window.saveTypingResult = async function(data) {
        try{
            await addDoc(collection(db, "typing_result"), {
                ...data,
                createdAt: serverTimestamp()
            });
            console.log("Sikeres mentés : ", data)
        } catch (e){
            console.error("Firebase mentési hiba : ", e)
        }
    };
    async function loadLeaderboard() {
        const leaderboardList = document.getElementById("leaderboardList")
        leaderboardList.innerHTML = ""

        //TODO : Pagination
        const q = query(collection(db, "typing_result"),
                        orderBy("wpm", "desc"),
                        limit(10)
                    )

        const snapshot = await getDocs(q)

        snapshot.docs.forEach((docItem, index) => {
            const data = docItem.data()

            const item = document.createElement("div")
            item.classList.add("lb-item")
            
            const rank = document.createElement("div")
            rank.classList.add("lb-rank")
            rank.textContent = index + 1

            if(index === 0) rank.classList.add("gold")
            else if(index === 1) rank.classList.add("silver")
            else if(index === 2) rank.classList.add("bronze")

            const name = document.createElement("div")
            name.classList.add("lb-name")
            name.textContent = data.name || "Ismeretlen"

            const wpm = document.createElement("div")
            wpm.classList.add("lb-wpm")
            wpm.textContent = data.wpm + " WPM"

            item.appendChild(rank)
            item.appendChild(name)
            item.appendChild(wpm)

            leaderboardList.appendChild(item)
        })
        
    }

    //FALLBACK
    const WORDS = [
        "alma","asztal","autó","ablak","barát","busz","ceruza","cukor","doboz","erdő",
        "fal","fény","gitár","ház","iskola","játék","kávé","kulcs","lámpa","motor",
        "nap","óra","papír","radír","szék","telefon","tenger","út","virág","zene"
    ]

    //Alapvető változók és DOM elemek
    const wordsContainer = document.getElementById('words');
    const input = document.getElementById('input');
    const timeEl = document.getElementById('time');
    const correctEl = document.getElementById('correct');
    const wrongEl = document.getElementById('wrong');
    const wpmEl = document.getElementById('wpm');
    const cpmEl = document.getElementById('cpm')
    const accuracyEl = document.getElementById("accuracy")

    const startBtn = document.getElementById('startBtn');
    const modal = document.getElementById('resultModal');
    const durationSelect = document.getElementById("duration")
    //Eredmény modal elemei
    const mCorrect = document.getElementById('mCorrect');
    const mWrong = document.getElementById('mWrong');
    const mWpm = document.getElementById('mWpm');

    //Játék változókat
    let words = [];
    let offset = 0;
    let correct = 0;
    let wrong = 0;
    let time = 60;
    let timer = null;
    let started = false;
    let localIndex = 0;
    let correctChars = 0
    let totalTime = 60
    let streak = 0

    window.API_WORDS = []

    //Random választunk ki 200 szót egy backend-ről érkező adatból
    async function randomWords(count = 200){
        if(!window.API_WORDS || window.API_WORDS.length === 0){
            await loadWordsFromApi()
        }

        return Array.from({length:count}, ()=>{
            return window.API_WORDS[Math.floor(Math.random() * window.API_WORDS.length)]
        })
    }

    window.hideModal = function(){
        modal.classList.add("hidden")
    }

    async function loadWordsFromApi() {
        try{
            const response = await fetch("https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt")
            const text = await response.text()
            const words = text.split("\n").map(w => w.trim()).filter(w => w.length > 3 && w.length < 10)

            window.API_WORDS = words
            console.log(window.API_WORDS)
        } catch(error){
            console.log(error)
            window.API_WORDS = WORDS
        }
    }

    //Random választunk ki 20 elemet a fallback-ből
    /* function randomWords(count = 20) {
        return Array.from({length:count}, ()=>{
            return WORDS[Math.floor(Math.random() * WORDS.length)]
        })
    } */

    function renderWords(){
        wordsContainer. innerHTML = "";
        const visible = words.slice(offset, offset + 12)
        visible.forEach((w,i)=>{
            const span = document.createElement("span")
            span.textContent = w + ", "
            span.classList.add("word")
            if(i === localIndex) span.classList.add('active')
            wordsContainer.appendChild(span)
        })
    }

    function updateStats(){
        const typed = correct + wrong
        const minutes = (totalTime - time) /60 || 1/60
        const wpm = Math.round(correct/minutes)
        const cpm = Math.round(correctChars/minutes)
        const accuracy = typed > 0 ? Math.round((correct/typed)*100) : 100

        wpmEl.textContent = wpm
        cpmEl.textContent = cpm
        accuracyEl.textContent = accuracy
    }

    function startTimer(){
        timer = setInterval(()=>{
            time--
            timeEl.textContent = time
            updateStats()
            if (time <= 0) endGame()
        },1000)
    }

    function endGame(){
        clearInterval(timer)
        input.disabled = true

        const minutes = (60-time)/60
        const finalwpm = Math.round(correct / minutes || 0)
        const finalCpm = Math.round(correctChars / minutes)
        const typed = correct + wrong
        const finalAccuracy = typed > 0 ? Math.round((correct / typed) * 100) : 0

        mCorrect.textContent = correct
        mWrong.textContent = wrong
        mWpm.textContent = finalwpm 

        modal.classList.remove("hidden")

        const playerName = prompt("Adja meg a nevét, ha szeretné tárolni az eredményét : ")

        if(playerName && playerName.trim() !== ""){
            window.saveTypingResult({
                name: playerName.trim(),
                duration: totalTime,
                correct: correct,
                wrong: wrong,
                wpm: finalwpm,
                cpm: finalCpm,
                accuracy: finalAccuracy
            })
        }
        loadLeaderboard()
    }

    input.addEventListener("keydown", e=>{
        if(!started){
            started = true
            startTimer()
        }
        if(e.key === " "){
            e.preventDefault()

            const value = input.value.trim()
            const currentWord = words[offset+localIndex]
            const wordSpan = wordsContainer.children[localIndex]
            
            if(value === currentWord){
                wordSpan.classList.add("correct")
                correct ++
                correctChars += value.length
                streak ++
                if(streak >= 2){
                    wordSpan.style.boxShadow = "0 0 8px #22c55e"
                }
            } else{
                wordSpan.classList.add("wrong")
                wrong ++
                streak = 0
            }

            localIndex++

            if(localIndex >= 12){
                offset+=12
                localIndex = 0
                renderWords()
            } else{
                wordSpan.classList.remove("active")
                wordsContainer.children[localIndex].classList.add("active")
            }

            input.value = ""
            correctEl.textContent = correct
            wrongEl.textContent = wrong
            updateStats()
        }
        
    })

    window.restart = function(){
        modal.classList.add("hidden")
        startBtn.classList.remove("hidden")
        wordsContainer.classList.add("hidden")

        clearInterval(timer)
        offset = 0
        localIndex = 0
        correct = 0
        wrong = 0
        time = parseInt(durationSelect.value)
        totalTime = time
        correctChars = 0
        streak = 0
        started = false

        input.value = ""
        input.disabled = true
        timeEl.textContent = time
        correctEl.textContent = 0
        wrongEl.textContent = 0
        wpmEl.textContent = 0
        cpmEl.textContent = 0
        accuracy.textContent = 100
    }

    startBtn.onclick = async () =>{
        time = parseInt(durationSelect.value)
        totalTime = time
        timeEl.textContent = time

        startBtn.classList.add('hidden');
        wordsContainer.classList.remove('hidden');
        input.disabled = false;
        input.focus();

        words = await randomWords()
        renderWords()
        console.log(words);
    }

    window.addEventListener("load", loadLeaderboard)
</script>
</body>
</html>